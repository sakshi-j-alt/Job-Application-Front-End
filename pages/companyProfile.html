<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Company Profile</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
    <style>
      body {
        background: linear-gradient(120deg, #f4f6f9 60%, #e8eaf6 100%);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .profile-banner {
        background: linear-gradient(90deg, #42a5f5 60%, #7e57c2 100%);
        height: 140px;
        border-radius: 18px 18px 0 0;
        position: relative;
      }
      .profile-avatar {
        width: 110px;
        height: 110px;
        border-radius: 50%;
        background: #fff;
        box-shadow: 0 4px 16px rgba(44, 62, 80, 0.12);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2.7rem;
        color: #42a5f5;
        position: absolute;
        left: 50%;
        top: 90px;
        transform: translateX(-50%);
        border: 4px solid #fff;
        font-weight: 700;
        text-transform: uppercase;
      }
      .profile-card {
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 6px 20px rgba(44, 62, 80, 0.1);
        max-width: 500px;
        margin: 80px auto 24px auto;
        padding: 0 0 32px 0;
        position: relative;
      }
      .profile-details {
        margin-top: 70px;
        padding: 0 32px;
      }
      .profile-details dt {
        color: #7b8ca3;
        font-weight: 500;
        width: 130px;
      }
      .profile-details dd {
        color: #2e3a59;
        margin-bottom: 16px;
        margin-left: 0;
        font-size: 1.05rem;
      }
      .profile-company {
        text-align: center;
        margin-top: 55px;
        margin-bottom: 10px;
      }
      .profile-company h2 {
        margin-bottom: 0;
        font-weight: 700;
        color: #2e3a59;
      }
      .profile-company small {
        color: #7b8ca3;
        font-size: 1rem;
      }
      .edit-btn-wrapper {
        text-align: center;
        margin-bottom: 40px;
      }
      .edit-btn-lg {
        font-size: 1.25rem;
        padding: 0.75rem 2.5rem;
        border-radius: 0.5rem;
      }
      @media (max-width: 576px) {
        .profile-card {
          padding: 0 0 18px 0;
        }
        .profile-details {
          padding: 0 10px;
        }
        .edit-btn-lg {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div class="profile-card">
      <div class="profile-banner"></div>
      <div class="profile-avatar" id="profileAvatar">TC</div>
      <div class="profile-company">
        <h2 id="compName">Loading...</h2>
        <small id="domain"></small>
      </div>
      <dl class="row profile-details">
        <dt class="col-sm-5">Company ID</dt>
        <dd class="col-sm-7" id="compId"></dd>
        <dt class="col-sm-5">Location</dt>
        <dd class="col-sm-7" id="location"></dd>
        <dt class="col-sm-5">Email</dt>
        <dd class="col-sm-7" id="compEmail">N/A</dd>
      </dl>
    </div>
    <div class="edit-btn-wrapper">
      <button class="btn btn-success edit-btn-lg" onclick="showEditModal()">
        <i class="bi bi-pencil"></i> Edit Profile
      </button>
    </div>

    <!-- Edit Modal -->
    <div
      class="modal fade"
      id="editModal"
      tabindex="-1"
      aria-labelledby="editModalLabel"
      aria-hidden="true"
    >
      <div class="modal-dialog">
        <form class="modal-content" id="editForm">
          <div class="modal-header">
            <h5 class="modal-title" id="editModalLabel">
              Edit Company Profile
            </h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
              aria-label="Close"
            ></button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editCompId" />
            <div class="mb-3">
              <label for="editCompName" class="form-label">Company Name</label>
              <input
                type="text"
                class="form-control"
                id="editCompName"
                required
              />
            </div>
            <div class="mb-3">
              <label for="editDomain" class="form-label">Domain</label>
              <input
                type="text"
                class="form-control"
                id="editDomain"
                required
              />
            </div>
            <div class="mb-3">
              <label for="editLocation" class="form-label">Location</label>
              <input
                type="text"
                class="form-control"
                id="editLocation"
                required
              />
            </div>
          </div>
          <div class="modal-footer">
            <button
              type="button"
              class="btn btn-outline-secondary"
              data-bs-dismiss="modal"
            >
              Cancel
            </button>
            <button type="submit" class="btn btn-primary">Save Changes</button>
          </div>
        </form>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const baseUrl = "http://localhost:8080"; // adjust as needed
      let company = null;
      let modal = null;
      // const userId = getUserId();/
      const userId = 8;

      async function loadCompanyProfile() {
        try {
          const userRes = await fetch(`${baseUrl}/api/users/${userId}`);
          if (!userRes.ok) throw new Error("User fetch failed");
          const user = await userRes.json();
          const res = await fetch(`${baseUrl}/api/companies/user/${userId}`);
          const companies = await res.json();
          company = companies;

          if (!company) throw new Error("No company found!");

          updateProfileUI(company, user);
        } catch (e) {
          document.getElementById("compName").textContent = "Not found";
          alert("Failed to load company profile.");
          console.error(e);
        }
      }

      function updateProfileUI(data, user) {
        document.getElementById("compName").textContent = data.companyName;
        document.getElementById("domain").textContent = data.companyDomain;
        document.getElementById("compId").textContent = data.companyId;
        document.getElementById("location").textContent = data.headOffice;
        document.getElementById("compEmail").textContent = user.userEmail;

        const initials = data.companyName
          .split(" ")
          .map((word) => word[0])
          .join("")
          .substring(0, 2)
          .toUpperCase();
        document.getElementById("profileAvatar").textContent = initials;
      }

      function showEditModal() {
        document.getElementById("editCompId").value = company.companyId;
        document.getElementById("editCompName").value = company.companyName;
        document.getElementById("editDomain").value = company.companyDomain;
        document.getElementById("editLocation").value = company.headOffice;

        if (!modal) {
          modal = new bootstrap.Modal(document.getElementById("editModal"));
        }
        modal.show();
      }

      document
        .getElementById("editForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();
          const updatedCompany = {
            companyName: document.getElementById("editCompName").value,
            companyDomain: document.getElementById("editDomain").value,
            headOffice: document.getElementById("editLocation").value,
          };

          try {
            const res = await fetch(
              `${baseUrl}/api/companies/${company.companyId}`,
              {
                method: "PUT",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(updatedCompany),
              }
            );

            if (!res.ok) throw new Error("Update failed");

            company = await res.json();
            updateProfileUI(company);
            bootstrap.Modal.getInstance(
              document.getElementById("editModal")
            ).hide();
            alert("Profile updated successfully!");
          } catch (err) {
            alert("Update failed!");
            console.error(err);
          }
        });

      loadCompanyProfile();
    </script>
  </body>
</html>
