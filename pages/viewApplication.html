<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Applications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
</head>
<body>
  <div class="container my-5">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#" onclick="loadPage('dashboard.html')">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Applications</li>
      </ol>
    </nav>

    <h2 class="mb-4">Applications for Company</h2>
    <div id="applicationCards" class="row g-4"></div>
  </div>

  <script>
    let applications = [];
    const baseUrl = "http://localhost:8080/api";
    const companyId = '2';

    fetch(`${baseUrl}/companies/${companyId}/applications`,{headers: {"Authorization": `Bearer ${token}`}})
      .then(response => response.json())
      .then(data => {
        applications = data; // <-- Assign fetched data here

        const container = document.getElementById('applicationCards');
        container.innerHTML = ''; // Clear previous cards if any

        data.forEach(app => {
          const card = document.createElement('div');
          card.className = 'col-md-4';
          card.innerHTML = `
            <div class="card shadow rounded h-100">
              <div class="card-body">
                <h5 class="card-title">${app.jobTitle}</h5>
                <p class="card-text"><strong>Applicant:</strong> ${app.applicantName}</p>
                <p class="card-text"><strong>Applied Date:</strong> ${app.appliedDate}</p>
                <p class="card-text">
                  <strong>Status:</strong>
                  <span class="badge ${
                    app.status === 'Accepted' ? 'bg-success' : 
                    app.status === 'Pending' ? 'bg-warning text-dark' : 
                    'bg-secondary'
                  }">${app.status}</span>
                </p>
                <div class="mt-3">
                  <select class="form-select mb-2" id="statusSelect-${app.applicationId}">
                    <option value="Pending" ${app.status === 'Pending' ? 'selected' : ''}>Pending</option>
                    <option value="Accepted" ${app.status === 'Accepted' ? 'selected' : ''}>Accepted</option>
                    <option value="Rejected" ${app.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
                  </select>
                  <button class="btn btn-sm btn-primary" onclick="updateStatus(${app.applicationId})">
                    <i class="bi bi-save"></i> Update Status
                  </button>
                </div>
              </div>
            </div>
          `;
          container.appendChild(card);
        });
      })
      .catch(error => {
        console.error('Error fetching applications:', error);
        document.getElementById('applicationCards').innerHTML =
          `<div class="alert alert-danger">Failed to load applications.</div>`;
      });

    function updateStatus(applicationId) {
      const newStatus = document.getElementById(`statusSelect-${applicationId}`).value;

      // Find full application object by ID
      const app = applications.find(a => a.applicationId === applicationId);
      if (!app) {
        alert("Application not found!");
        return;
      }

      // Build full updated application object
      const updatedApplication = {
        applicationId: app.applicationId,
        appliedDate: app.appliedDate,  // keep the same
        status: newStatus,
        
      };

      fetch(`${baseUrl}/application/${applicationId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" ,
          "Authorization": `Bearer ${token}`
        },
        body: JSON.stringify(updatedApplication)
      })
      .then(response => {
        if (!response.ok) throw new Error("Failed to update status.");
        return response.json();
      })
      .then(updatedApp => {
        alert("Status updated successfully.");
        // Optionally, update the badge color & text dynamically without full reload
        const badge = document.querySelector(`#statusSelect-${applicationId}`).parentElement.previousElementSibling.querySelector('span.badge');
        if (badge) {
          badge.textContent = updatedApp.status;
          badge.className = 'badge ' + (
            updatedApp.status === 'Accepted' ? 'bg-success' : 
            updatedApp.status === 'Pending' ? 'bg-warning text-dark' : 
            'bg-secondary'
          );
        }
      })
      .catch(error => {
        console.error('Error updating status:', error);
        alert("Failed to update status.");
      });
    }
  </script>
</body>

</html>
