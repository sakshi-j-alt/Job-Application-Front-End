<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Company Applications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="p-4">
  <div class="container">
    <h2 class="mb-4">Applications for Company</h2>
    <table class="table table-bordered" id="applicationsTable">
      <thead>
        <tr>
          <th>ID</th>
          <th>Candidate ID</th>
          <th>Job ID</th>
          <th>Job Title</th>
          <th>Status</th>
          <th>Update</th>
        </tr>
      </thead>
      <tbody id="tableBody">
        <!-- Populated by JS -->
      </tbody>
    </table>
  </div>

  <script>
    (
      function(){
        const apiBase = 'http://localhost:8080/api/application'; // Adjust path as per your actual API route

    async function fetchApplications() {
      try {
        const res = await fetch(`${apiBase}/applicationInfo`);
        const data = await res.json();
        console.log(data)
        populateTable(data);
      } catch (error) {
        alert("Failed to load applications.");
        console.error(error);
      }
    }

    function populateTable(applications) {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '';

      applications.forEach(app => {
        const row = document.createElement('tr');

        row.innerHTML = `
          <td>${app.applicationId}</td>
          <td>${app.userId}</td>
          <td>${app.jobId}</td>
          <td>${app.jobTitle}</td>
          <td>
            <select class="form-select" id="status-${app.applicationId}">
              <option value="Pending" ${app.status === 'Applied' ? 'selected' : ''}>Pending</option>
              <option value="Shortlisted" ${app.status === 'Shortlisted' ? 'selected' : ''}>Shortlisted</option>
              <option value="Rejected" ${app.status === 'Rejected' ? 'selected' : ''}>Rejected</option>
              <option value="Offered" ${app.status === 'Offered' ? 'selected' : ''}>Offered</option>
            </select>
          </td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="updateStatus(${app.applicationId}, ${app.userId}, ${app.jobId})">
              Update
            </button>
          </td>
        `;

        tbody.appendChild(row);
      });
    }

    window.updateStatus = async function (applicationId, userId, jobId, appliedDate) {
      const newStatus = document.getElementById(`status-${applicationId}`).value;
      console.log(newStatus)
      console.log(userId)
      console.log(jobId)
      console.log(appliedDate)
      let userData = await fetch(`http://localhost:8080/api/users/${userId}`).then(res=>res.json());
      let jobData  = await fetch(`http://localhost:8080/api/jobs/${jobId}`).then(res=>res.json());
      console.log(userData)
      const updatedApp = {
        applicationId: applicationId,
        user: userData,
        job: jobData,
        status: newStatus
      };

      console.log(updatedApp)
      const res = await fetch(`${apiBase}/${applicationId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedApp)
      });

      if (res.ok) {
        alert('Status updated successfully!');
        fetchApplications();
      } else {
        alert('Error updating application.');
      }
    }

    // Load applications on page load
    fetchApplications();
      }
    )();
  </script>
</body>
</html>
