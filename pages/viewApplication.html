<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Company Applications</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <div class="container">
      <h2 class="mb-4">Applications for Company</h2>
      <table class="table table-bordered" id="applicationsTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Candidate</th>
            <th>Job Title</th>
            <th>Applied Date</th>
            <th>Status</th>
            <th>Update</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Populated by JS -->
        </tbody>
      </table>
    </div>

    <script>
      const companyId = 1; // Change this based on logged-in company
      const apiBase = "http://localhost:8080/api/application";

      async function fetchApplications() {
        const res = await fetch(`${apiBase}/company/${companyId}`);
        const data = await res.json();
        populateTable(data);
      }

      function populateTable(applications) {
        const tbody = document.getElementById("tableBody");
        tbody.innerHTML = "";

        applications.forEach((app) => {
          const row = document.createElement("tr");

          row.innerHTML = `
          <td>${app.applicationId}</td>
          <td>${app.user.userName}</td>
          <td>${app.job.jobTitle}</td>
          <td>${app.appliedDate}</td>
          <td>
            <select class="form-select" id="status-${app.applicationId}">
              <option value="Pending" ${
                app.status === "Pending" ? "selected" : ""
              }>Pending</option>
              <option value="Accepted" ${
                app.status === "Accepted" ? "selected" : ""
              }>Accepted</option>
              <option value="Rejected" ${
                app.status === "Rejected" ? "selected" : ""
              }>Rejected</option>
            </select>
          </td>
          <td>
            <button class="btn btn-primary btn-sm" onclick="updateStatus(${
              app.applicationId
            })">Update</button>
          </td>
        `;

          tbody.appendChild(row);
        });
      }

      async function updateStatus(applicationId) {
        const status = document.getElementById(`status-${applicationId}`).value;

        // Fetch existing application for full PUT
        const res = await fetch(`${apiBase}/${applicationId}`);
        const existingApp = await res.json();

        const updatedApp = {
          applicationId: existingApp.applicationId,
          userId: existingApp.user.userId,
          jobId: existingApp.job.jobId,
          appliedDate: existingApp.appliedDate,
          status: status, // Use the selected new status here
        };

        const updateRes = await fetch(`${apiBase}/${applicationId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(updatedApp),
        });

        if (updateRes.ok) {
          alert("Status updated successfully!");
          fetchApplications();
        } else {
          alert("Error updating application.");
        }
      }

      // Initial fetch
      fetchApplications();
    </script>
  </body>
</html>
