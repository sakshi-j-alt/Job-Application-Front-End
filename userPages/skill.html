<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Skill Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css"
      rel="stylesheet"
    />
  </head>
  <body class="container my-5">
    <h2 class="mb-4">Skill Management</h2>

    <div class="mb-4">
      <label for="selectSkill" class="form-label">Assign Skill to User</label>
      <select id="selectSkill" class="form-select mb-2">
        <option value="">-- Select Skill --</option>
      </select>
      <button class="btn btn-success" onclick="addSkillToUser()">
        Assign Skill
      </button>
    </div>

    <input
      type="text"
      placeholder="Search by Skill Name..."
      class="form-control mb-3"
      id="searchInput"
    />

    <table class="table table-bordered">
      <thead>
        <tr>
          <th>ID</th>
          <th style="cursor: pointer">
            Skill Name <i class="bi bi-arrow-down-up"></i>
          </th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="skillTableBody"></tbody>
    </table>

    <script>
      const baseUrl = "http://localhost:8080"; // <-- Replace with your backend URL
      const userId = 2;

      const skillForm = document.getElementById("skillForm");
      const skillNameInput = document.getElementById("skillName");
      const submitBtn = document.getElementById("submitBtn");
      const searchInput = document.getElementById("searchInput");
      const skillTableBody = document.getElementById("skillTableBody");
      const selectSkill = document.getElementById("selectSkill");

      let allSkills = [];
      let editId = null;
      let sortDirection = 1;

      function validateForm() {
        if (skillNameInput.value.trim().length < 2) {
          skillNameInput.classList.add("is-invalid");
          return false;
        }
        skillNameInput.classList.remove("is-invalid");
        return true;
      }

      function fetchSkills() {
        fetch(`${baseUrl}/api/skills`, {
          headers: { "Content-Type": "application/json" },
        })
          .then((res) => res.json())
          .then((data) => {
            allSkills = data;
            renderSkills(data);
            populateSkillDropdown(data);
          });
      }

      function populateSkillDropdown(data) {
        selectSkill.innerHTML = '<option value="">-- Select Skill --</option>';
        data.forEach((skill) => {
          selectSkill.innerHTML += `<option value="${skill.skillId}">${skill.skillName}</option>`;
        });
      }

      function renderSkills(skills) {
        skillTableBody.innerHTML = "";
        skills.forEach((skill) => {
          const row = document.createElement("tr");
          row.innerHTML = `
            <td>${skill.skillId}</td>
            <td>${skill.skillName}</td>
            <td>
              <button class="btn btn-sm btn-outline-primary edit-btn" data-id="${skill.skillId}">
                <i class="bi bi-pencil-square"></i>
              </button>
              <button class="btn btn-sm btn-outline-danger delete-btn" data-id="${skill.skillId}">
                <i class="bi bi-trash"></i>
              </button>
            </td>
          `;
          skillTableBody.appendChild(row);
        });

        document.querySelectorAll(".edit-btn").forEach((btn) => {
          btn.addEventListener("click", () => loadSkill(btn.dataset.id));
        });

        document.querySelectorAll(".delete-btn").forEach((btn) => {
          btn.addEventListener("click", () => deleteSkill(btn.dataset.id));
        });
      }

      function loadSkill(id) {
        fetch(`${baseUrl}/api/skills/${id}`, {
          headers: { "Content-Type": "application/json" },
        })
          .then((res) => res.json())
          .then((skill) => {
            skillNameInput.value = skill.skillName;
            editId = skill.skillId;
            submitBtn.textContent = "Update Skill";
          });
      }

      function deleteSkill(id) {
        if (confirm("Are you sure you want to delete this skill?")) {
          fetch(`${baseUrl}/api/skills/${id}`, {
            method: "DELETE",
            headers: { "Content-Type": "application/json" },
          }).then(fetchSkills);
        }
      }

      skillForm.addEventListener("submit", (e) => {
        e.preventDefault();
        if (!validateForm()) return;

        const skill = { skillName: skillNameInput.value.trim() };

        if (editId) {
          fetch(`${baseUrl}/api/skills/${editId}`, {
            method: "PUT",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(skill),
          }).then(() => {
            fetchSkills();
            skillForm.reset();
            submitBtn.textContent = "Add Skill";
            editId = null;
          });
        } else {
          fetch(`${baseUrl}/api/skills`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(skill),
          }).then(() => {
            fetchSkills();
            skillForm.reset();
          });
        }
      });

      searchInput.addEventListener("input", () => {
        const searchTerm = searchInput.value.toLowerCase();
        const filtered = allSkills.filter((s) =>
          s.skillName.toLowerCase().includes(searchTerm)
        );
        renderSkills(filtered);
      });

      document
        .querySelector("th:nth-child(2)")
        .addEventListener("click", () => {
          const sorted = [...allSkills].sort(
            (a, b) => a.skillName.localeCompare(b.skillName) * sortDirection
          );
          sortDirection *= -1;
          renderSkills(sorted);
        });

      function addSkillToUser() {
        const skillId = selectSkill.value;
        if (!skillId) return alert("Please select a skill");

        fetch(`${baseUrl}/api/users/${userId}/addSkill`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ skillId: Number(skillId) }),
        })
          .then((res) => res.text())
          .then((msg) => {
            alert(msg);
          })
          .catch((err) => console.error("Error:", err));
      }

      // Initial load
      fetchSkills();
    </script>
  </body>
</html>
