<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>My Applications</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f4f6f9; }
    .table thead { background: #027bf5; color: #fff; }
    .status-badge { font-size: 0.95rem; }
    .modal-header { background: #027bf5; color: #fff; }
  </style>
</head>
<body>
  <div class="container py-4">
    <h2 class="mb-4">My Applications</h2>
    <!-- Chart -->
    <div class="mb-5" style="max-width: 500px;">
      <canvas id="statusChart"></canvas>
    </div>
    <!-- Applications Table -->
    <div class="table-responsive">
      <table class="table align-middle shadow-sm bg-white">
        <thead>
          <tr>
            <th>#</th>
            <th>Company</th>
            <th>Role</th>
            <th>Status</th>
            <th>Applied On</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="applicationsTableBody">
          <!-- Rows injected by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Job Details Modal -->
  <div class="modal fade" id="jobDetailsModal" tabindex="-1" aria-labelledby="jobDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="jobDetailsModalLabel">Job Details</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="jobDetailsContent">
          <!-- Job details will be injected here -->
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
   
    // function getUserId() {
    //   // Example: Replace with your actual JWT/session extraction
    //   const token = localStorage.getItem("token");
    //   if (!token) window.location.href = "login.html";
    //   const payload = JSON.parse(atob(token.split('.')[1]));
    //   return payload.userid;
    // }
    const userId = 2;

    let allApplications = [];

    // Fetch applications for the current user
    async function loadApplications() {
      try {
        const res = await fetch(`${baseUrl}/api/application`);
        const applications = await res.json();
        // Filter applications for current user
        allApplications = applications.filter(app => app.user && app.user.userId == userId);
        renderApplicationsTable(allApplications);
        renderStatusChart(allApplications);
      } catch (err) {
        document.getElementById('applicationsTableBody').innerHTML =
          `<tr><td colspan="6" class="text-danger">Failed to load applications.</td></tr>`;
        console.error(err);
      }
    }

    // Render applications table
    function renderApplicationsTable(applications) {
      const tbody = document.getElementById('applicationsTableBody');
      if (!applications.length) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-muted">No applications found.</td></tr>`;
        return;
      }
      tbody.innerHTML = applications.map((app, idx) => `
        <tr>
          <td>${idx + 1}</td>
          <td>${app.job && app.job.company ? app.job.company.companyName : 'N/A'}</td>
          <td>${app.job ? app.job.jobTitle : 'N/A'}</td>
          <td>
            <span class="badge status-badge bg-${getStatusColor(app.status)}">
              ${app.status}
            </span>
          </td>
          <td>${app.appliedDate || ''}</td>
          <td>
            <button class="btn btn-outline-primary btn-sm" onclick="showJobDetails(${app.job ? app.job.jobId : 0})">
              View Details
            </button>
          </td>
        </tr>
      `).join('');
    }

    // Status color mapping
    function getStatusColor(status) {
      switch ((status || '').toLowerCase()) {
        case 'approved': return 'success';
        case 'rejected': return 'danger';
        case 'pending': return 'warning';
        default: return 'secondary';
      }
    }

    // Chart for application status
    function renderStatusChart(applications) {
      const statusCounts = {};
      applications.forEach(app => {
        const status = (app.status || 'Unknown').toLowerCase();
        statusCounts[status] = (statusCounts[status] || 0) + 1;
      });
      const labels = Object.keys(statusCounts).map(s => s.charAt(0).toUpperCase() + s.slice(1));
      const data = Object.values(statusCounts);

      if (window.statusChartInstance) window.statusChartInstance.destroy();
      window.statusChartInstance = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
          labels,
          datasets: [{
            data,
            backgroundColor: ['#ffc107', '#28a745', '#dc3545', '#6c757d'],
          }]
        },
        options: {
          plugins: {
            legend: { position: 'bottom' }
          }
        }
      });
    }

    // Show job details in modal
    async function showJobDetails(jobId) {
      if (!jobId) return;
      try {
        const res = await fetch(`${baseUrl}/api/jobs/${jobId}`);
        if (!res.ok) throw new Error("Job not found");
        const job = await res.json();
        document.getElementById('jobDetailsContent').innerHTML = `
          <h4 class="mb-3 text-primary">${job.jobTitle}</h4>
          <div class="row mb-2">
            <div class="col-md-6">
              <p><strong>Company:</strong> ${job.company ? job.company.companyName : 'N/A'}</p>
              <p><strong>Location:</strong> ${job.jobLocation || 'N/A'}</p>
            </div>
            <div class="col-md-6">
              <p><strong>Salary:</strong> â‚¹${job.salary ? job.salary.toLocaleString() : 'N/A'}</p>
              <p><strong>Posting Date:</strong> ${job.postingDate || 'N/A'}</p>
              <p><strong>Deadline:</strong> ${job.deadlineDate || 'N/A'}</p>
            </div>
          </div>
          <hr/>
          <h5>Description</h5>
          <p>${job.description || ''}</p>
        `;
        new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
      } catch (err) {
        document.getElementById('jobDetailsContent').innerHTML =
          `<p class="text-danger">Failed to load job details.</p>`;
        new bootstrap.Modal(document.getElementById('jobDetailsModal')).show();
        console.error(err);
      }
    }

    // Initial load
    loadApplications();
  </script>
</body>
</html>
