<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Job Portal Analytics</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <style>
      body {
        background: linear-gradient(120deg, #f4f6f9 60%, #e8eaf6 100%);
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }
      .container {
        max-width: 1100px;
      }
      .chart-container {
        margin: 20px auto;
        padding: 18px 20px;
        background: #fff;
        border-radius: 18px;
        box-shadow: 0 6px 20px rgba(44, 62, 80, 0.08);
        transition: box-shadow 0.2s;
      }
      .chart-container:hover {
        box-shadow: 0 10px 32px rgba(44, 62, 80, 0.14);
      }
      h1,
      h4 {
        color: #2e3a59;
      }
      canvas {
        width: 100% !important;
        height: 340px !important;
      }
      @media (max-width: 768px) {
        .chart-container {
          padding: 12px 5px;
        }
        canvas {
          height: 220px !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container py-4">
      <h1 class="text-center mb-5 fw-bold">Job Portal Analytics</h1>
      <div class="row g-4">
        <div class="col-md-6">
          <div class="chart-container">
            <h4 class="text-center mb-3">Applications by Location</h4>
            <canvas
              id="locationChart"
              aria-label="Applications by Location"
              role="img"
            ></canvas>
          </div>
        </div>
        <div class="col-md-6">
          <div class="chart-container">
            <h4 class="text-center mb-3">Jobs by Industry</h4>
            <canvas
              id="industryChart"
              aria-label="Jobs by Industry"
              role="img"
            ></canvas>
          </div>
        </div>
        <div class="col-12">
          <div class="chart-container">
            <h4 class="text-center mb-3">Applications by Job Role</h4>
            <canvas
              id="roleChart"
              aria-label="Applications by Job Role"
              role="img"
            ></canvas>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Utility function to get unique values from an array
      function unique(arr) {
        return Array.from(new Set(arr));
      }

      // Fetch all required data and render charts
      async function renderCharts() {
        // Fetch data from all endpoints in parallel
        const [users, companies, jobs, applications] = await Promise.all([
          fetch("http://localhost:3001/user").then((res) => res.json()),
          fetch("http://localhost:3001/company").then((res) => res.json()),
          fetch("http://localhost:3001/job").then((res) => res.json()),
          fetch("http://localhost:3001/application").then((res) => res.json()),
        ]);

        // --- Applications by Location ---
        // For each application, get the user, then group by user.address
        const locationCounts = {};
        applications.forEach((app) => {
          const user = users.find((u) => u.userId === app.userId);
          if (user && user.address) {
            locationCounts[user.address] =
              (locationCounts[user.address] || 0) + 1;
          }
        });
        const locationLabels = Object.keys(locationCounts);
        const locationData = Object.values(locationCounts);

        // --- Jobs by Industry ---
        // For each job, get its company, then group by company.domain
        const industryCounts = {};
        jobs.forEach((job) => {
          const company = companies.find((c) => c.compId === job.compId);
          if (company && company.domain) {
            industryCounts[company.domain] =
              (industryCounts[company.domain] || 0) + 1;
          }
        });
        const industryLabels = Object.keys(industryCounts);
        const industryData = Object.values(industryCounts);

        // --- Applications by Job Role ---
        // For each application, get the job, then group by job.title
        const roleCounts = {};
        applications.forEach((app) => {
          const job = jobs.find((j) => j.jobid === app.jobid);
          if (job && job.title) {
            roleCounts[job.title] = (roleCounts[job.title] || 0) + 1;
          }
        });
        const roleLabels = Object.keys(roleCounts);
        const roleData = Object.values(roleCounts);

        // Colors
        const palette = [
          "#42a5f5",
          "#66bb6a",
          "#ffa726",
          "#ab47bc",
          "#d32f2f",
          "#29b6f6",
          "#ef5350",
          "#8d6e63",
          "#00bcd4",
          "#ffb300",
          "#7e57c2",
          "#43a047",
          "#e53935",
          "#5c6bc0",
          "#bdbdbd",
        ];

        // Chart 1: Applications by Location
        new Chart(document.getElementById("locationChart"), {
          type: "bar",
          data: {
            labels: locationLabels,
            datasets: [
              {
                label: "Applications",
                data: locationData,
                backgroundColor: palette.slice(0, locationLabels.length),
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            animation: { duration: 1200 },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: "#444", stepSize: 1 },
              },
              x: {
                ticks: { color: "#444" },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => ` ${context.parsed.y} Applications`,
                },
              },
            },
          },
        });

        // Chart 2: Jobs by Industry
        new Chart(document.getElementById("industryChart"), {
          type: "doughnut",
          data: {
            labels: industryLabels,
            datasets: [
              {
                label: "Jobs",
                data: industryData,
                backgroundColor: palette.slice(0, industryLabels.length),
                borderWidth: 2,
                hoverOffset: 10,
              },
            ],
          },
          options: {
            responsive: true,
            animation: { animateRotate: true, duration: 1400 },
            plugins: {
              legend: {
                position: "bottom",
                labels: { color: "#444", font: { weight: "bold" } },
              },
              tooltip: {
                callbacks: {
                  label: (context) =>
                    ` ${context.label}: ${context.parsed} Jobs`,
                },
              },
            },
          },
        });

        // Chart 3: Applications by Job Role
        new Chart(document.getElementById("roleChart"), {
          type: "bar",
          data: {
            labels: roleLabels,
            datasets: [
              {
                label: "Applications",
                data: roleData,
                backgroundColor: palette.slice(0, roleLabels.length),
                borderRadius: 6,
              },
            ],
          },
          options: {
            responsive: true,
            animation: { duration: 1200 },
            scales: {
              y: {
                beginAtZero: true,
                ticks: { color: "#444", stepSize: 1 },
              },
              x: {
                ticks: { color: "#444" },
              },
            },
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: (context) => ` ${context.parsed.y} Applications`,
                },
              },
            },
          },
        });
      }

      // Run on page load
      renderCharts().catch((err) => {
        alert(
          "Failed to load analytics data. Please make sure your backend is running."
        );
        console.error(err);
      });
    </script>
  </body>
</html>
